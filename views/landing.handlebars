<div class="main-body container">
    <div class="row">
        <h2>Search</h2>
    </div>
    <div class="row">

        <div class="col-md-3 index_select">

            <div>
                <select class="form-control" id="selected_index">
                    <option>Select Index</option>
                    <option value="market">Meterial</option>
                    <option value="customer">Customer</option>
                </select>
            </div>
        </div>

        <div class="col-md-9">
            <div id="custom-search-input row">
                <div class="input-group col-md-12">

                    <input type="text" id="search-text" class="form-control input-lg" placeholder="Search ..."/>

                    <span class="input-group-btn">
                        <button class="btn btn-info btn-lg" id="search" type="button">
                            Search
                        </button>
                    </span>
                </div>

            </div>
            <div class="col-md-3">

                <ul class="dropdown-menu">
                    <li><a href="#">HTML</a></li>
                    <li><a href="#">CSS</a></li>
                    <li><a href="#">JavaScript</a></li>
                    <li><a href="#">About Us</a></li>
                </ul>

            </div>


        </div>
    </div>

    <table id="customer_table" class="display hidden customer_results" style="width: 100%">
        <thead>
        <tr>
            <th style="color:#3c763d" class="resultCount"></th>
        </tr>
        <tr>
            <th>kna1_kunnr</th>
            <th>kna1_land1</th>
            <th>kna1_name1</th>
            <th>kna1_name2</th>
            <th>kna1_ort01</th>
            <th>kna1_pstlz</th>
            <th>kna1_stras</th>
            <th>knb1_props</th>
            <th>knvk_props</th>
        </tr>

        <tbody>
        </tbody>
        </thead>
    </table>
    <table id="meterial_table" class="display hidden results" style="width:100%">
        <thead>
        <tr>
            <th style="color:#3c763d" class="resultCount"></th>
        </tr>
        <tr>
            <th>Material Number</th>
            <th>Material Type</th>
            <th>Description</th>
            <th>Material Group</th>
            <th>Packaging Material Type</th>
            <th>Created On</th>
            <th>Name of Person who Created the Object</th>
            <th>Maintenance status</th>
            <th>Industry Sector</th>
            <th>Base Unit of Measure</th>
            <th>Product hierarchy</th>
        </tr>

        <tbody>
        </tbody>
        </thead>

    </table>
    <div class="row">
        <div id="show-pagination">
        </div>
        <!--<input class="hidden btn btn-default" id="loadMore" value="Load More" type="button" onclick="loadMore()">-->
    </div>
</div>


<script type="text/html" id="template">
    <% if(data.showPrevious){%>
    <input type="button" onclick="previousSlotPagination()" class="pagination previous" value="<">
    <%}%>
    <%for(let dcount=data.start;dcount<=data.count;dcount++){%>
    <a onclick="showNextPage(this)" id="page_no_<%=dcount%>" href="javascript:void(0)"
       value=<%=dcount%>><b><%=dcount%></b></a>
    <%}%>

    <% if(data.showNext){%>
    <input id="nextSlot" type="button" onclick="nextSlotPagination()" class="pagination next" value=">">
    <%}%>
</script>
<script>
    let maximumPagination = 0

    function nextSlotPagination() {
        let text = getUrlParameter('search-text')
        let pageNo = getUrlParameter('page')
        let index = getUrlParameter('index') || 'makt'
        if (!pageNo) {
            pageNo = 0
        }
        pageNo = parseInt(pageNo) + 1
        if (text) {
            location.href = '/?search-text=' + text + '&page=' + pageNo + '&index=' + index
        }
    }

    function previousSlotPagination() {
        let text = getUrlParameter('search-text')
        let pageNo = getUrlParameter('page')
        let index = getUrlParameter('index') || 'makt'
        if (!pageNo) {
            pageNo = 0
        }
        pageNo = parseInt(pageNo) - 1
        if (pageNo < 0) {
            pageNo = 0
        }
        if (text) {
            location.href = '/?search-text=' + text + '&page=' + pageNo + '&index=' + index
        }
    }

    function showNextPage(that) {
        let text = getUrlParameter('search-text')
        let pageNo = $(that).attr('value')
        let index = getUrlParameter('index') || 'makt'
        let redirectText = '/?search-text=' + text
        if (pageNo > 0) {
            redirectText = redirectText + '&page=' + pageNo + '&index=' + index
        }
        if (!pageNo || pageNo < 0) {
            pageNo = 0
        }

        location.href = redirectText
    }

    let showNext = false
    let showPrevious = false
    var getUrlParameter = function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : sParameterName[1];
            }
        }
    };

    (function () {
        let text = getUrlParameter('search-text')
        let index = getUrlParameter('index') || 'market'

        $("#search-text").val(text)
        $("#selected_index").val(index)

        if (text) {
            let pageNo = getUrlParameter('page')
            if (!pageNo || !pageNo / 1) {
                pageNo = 0
            }
            if (pageNo > 0) {
                pageNo = pageNo - 1
            }

            loadMore(index, text.trim(), pageNo)
        }

    })()

    function loadMore(index, searchText, pagination) {
        //  let searchText = $("#search-text").val().trim()
        if (!index || index == "") {
            return false
        }
        let source = []
        if (index == 'market') {
            source = ['mara_matnr', 'mara_mtart', 'mara_matkl', 'mara_vhart', 'mara_ersda', 'mara_ernam', 'mara_pstat', 'mara_mbrsh', 'mara_meins', 'mara_prdha', 'makt_props']
        }
        if (searchText && (searchText == "" || !searchText || searchText.length < 3)) {
            $('#meterial_table').addClass('hidden')
            $('#loadMore').addClass('hidden')
            return false
        }
        $.ajax({
            url: '../api/search',
            data: JSON.stringify({
                index: index,
                text: searchText,
                from: pagination * 10,
                source: source
            }),
            method: 'POST',
            dataType: 'json',
            contentType: "application/json",
            success: function (data) {
                if (index == 'market') {
                    $('.results').removeClass('hidden')
                } else {
                    $('.customer_results').removeClass('hidden')
                }
                var template = $('#template').html();
                let pageCount = Math.floor(data.count / 10)
                let extraPage = Math.floor(data.count % 10)
                if (pageCount > 0 && extraPage > 0) {
                    pageCount = pageCount + 1
                }
                let pageStart = 1
                if (pagination > 0) {
                    showPrevious = true
                }
                if (pageCount > 5) {
                    if (pagination <= 0) {
                        pageStart = pagination + 1
                    } else {
                        pageStart = pagination
                    }
                    pageCount = pagination + 5
                    $(".next").removeClass('hidden')
                    showNext = true
                }

                var compiled_html = _.template(template)({
                    data: {start: pageStart, count: pageCount, showNext: showNext, showPrevious: showPrevious}
                })
                if (data.result.length > 1) {
                    console.log(data.time)
                    // $(".resultCount").html("<span>" + data.time + "</span>" + "<h3><i class=\"fa fa-save\"></i></h3>")
                }

                if (data.count > 10) {
                    $("#show-pagination").append(compiled_html)
                }
                if (data.result.length < 10) {
                    $("#nextSlot").attr('disabled', true)
                }
                let pageNo = pagination + 1
                $('#page_no_' + pageNo).addClass('clicked')
                let final_data = data.result
                var counter = 1;
                if (index == "market") {
                    for (let j = 0; j < final_data.length; j++) {
                        let maktMaktx = final_data[j]['makt_props'].map(function (data) {
                            return data.makt_maktx
                        })
                        maktMaktx = maktMaktx.join("<br /><br />");
                        console.log(final_data[j]['makt_props'][0].makt_maktx)
                        $('#meterial_table').dataTable().fnAddData([
                            final_data[j].mara_matnr,
                            final_data[j].mara_mtart,
                            maktMaktx,
                            final_data[j].mara_matkl,
                            final_data[j].mara_vhart,
                            final_data[j].mara_ersda,
                            final_data[j].mara_ernam,
                            final_data[j].mara_pstat,
                            final_data[j].mara_mbrsh,
                            final_data[j].mara_meins,
                            final_data[j].mara_prdha,

                        ]);
                    }
                } else {
                    for (let j = 0; j < final_data.length; j++) {
                        let knb1_props = []

                        final_data[j]["knb1_props"].forEach(function (data) {
                            let html_data = []
                            html_data.push("knb1_akont: " + data["knb1_akont"] + ',' + " knb1_bukrs : " + data['knb1_bukrs'] + ',' + " knb1_kunnr: " + data['knb1_kunnr'] + ',' + " knb1_zterm :" + data['knb1_zterm'])
                            knb1_props.push(html_data)
                        })
                        knb1_props = knb1_props.join("<br /><br />");

                       let knvk_props=[]
                            final_data[j]["knvk_props"].forEach(function (data) {
                                let html_data=[]
                                html_data.push("knvk_kunnr: "+data['knvk_kunnr']+','+" knvk_namev: "+data['knvk_namev']+','+" knvk_name1: "+data['knvk_name1'])
                                knvk_props.push(html_data)
                            })
                        knvk_props = knvk_props.join("<br /><br />");
                        $('#customer_table').dataTable().fnAddData([
                            final_data[j].kna1_kunnr,
                            final_data[j].kna1_land1,
                            final_data[j].kna1_name1,
                            final_data[j].kna1_name2,
                            final_data[j].kna1_ort01,
                            final_data[j].kna1_pstlz,
                            final_data[j].kna1_stras,
                            knb1_props,
                            knvk_props


                        ]);
                    }
                }

                pagination++;

            }, error: function (error) {

                let msg = JSON.parse(error.responseText)
                alert(msg.message)
            }
        })
    }

    $("#search").on('click', function () {
        let searchText = $("#search-text").val().trim()
        let index = $("#selected_index").val()
        location.href = '/?search-text=' + searchText + '&index=' + index
    })
    $("#search-text").bind("keypress", {}, keypressInBox);

    function keypressInBox(e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) { //Enter keycode
            e.preventDefault();
            let searchText = $("#search-text").val().trim()
            let index = $("#selected_index").val()
            location.href = '/?search-text=' + searchText + '&index=' + index
        }
    };
    $(document).ready(function () {
        $('#meterial_table').DataTable({
            "dom": 'Zlfrtip',
            "colResize": {
                "tableWidthFixed": false
            },
            "paging": false

        });
        $('#customer_table').DataTable({
            "dom": 'Zlfrtip',
            "colResize": {
                "tableWidthFixed": false
            },
            "paging": false

        });
        /* $('#search-text').on('keyup', function (word) {
             let txt = $('#search-text').val().trim()
             if (txt.length > 2) {
                 $.ajax({
                     url: '/api/suggest-search',
                     method: 'POST',
                     dataType: 'json',
                     data:JSON.stringify({
                         text:txt,
                         source:['mara_matnr','mara_mtart','mara_ernam','makt_props.makt_maktx']
                     }),
                     contentType: "application/json",
                     success: function (data) {
                             let showText=[]
                             let mara_ernam=data.mara_ernam.split(' ')


                     }
                 })
                 //
             }
         })
         */
    });
</script>