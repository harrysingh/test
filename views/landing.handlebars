<div class="main-body container">
    <div class="row">
        <h2>Search</h2>
    </div>
    <div class="row">

        <div class="col-md-2 index_select">

            <div>
                <select class="form-control" id="selected_index">
                    <option>Select Index</option>
                    <option value="market">Meterial</option>
                    <option value="customer">Customer</option>
                </select>
            </div>


        </div>
        <div class="col-md-1">
            <i class="fa fa-upload" aria-hidden="true"></i>
            <i class="fa fa-file-excel-o hidden" aria-hidden="true"></i>
            <i class="fa hidden fa-close"></i>

        </div>
        <div class="col-md-9">
            <div id="custom-search-input row">
                <div class="input-group col-md-12">

                    <input type="text" id="search-text" class="form-control input-lg" placeholder="Search ..."/>

                    <span class="input-group-btn">
                        <button class="btn btn-info btn-lg" id="search" type="button">
                            Search
                        </button>
                    </span>
                </div>

            </div>


        </div>
    </div>
    <div class="row">
        <div class="col-md-6">

            <form id="upload-photos" method="post" action="/api/uploadFile" enctype="multipart/form-data">
                <div class="form-group">
                    <input id="photos-input" class="hidden" type="file" name="photos[]" multiple="multiple">
                </div>
                <input type="hidden" name="csrf_token" value="just_a_text_field"/>
                <!--<input class="btn btn-default" type="submit" name="Photo Uploads" value="Upload Photos" />-->
            </form>
        </div>
    </div>


    <table id="customer_table" class="display hidden customer_results" style="width: 100%">
        <thead>
        <tr>
            <th style="color:#3c763d" class="resultCount"></th>
        </tr>
        <tr>
            <th>kna1_kunnr</th>
            <th>kna1_land1</th>
            <th>kna1_name1</th>
            <th>kna1_name2</th>
            <th>kna1_ort01</th>
            <th>kna1_pstlz</th>
            <th>kna1_stras</th>
            <th>knb1_props</th>
            <th>knvk_props</th>
        </tr>

        <tbody>
        </tbody>
        </thead>
    </table>
    <table id="meterial_table" class="display hidden results" style="width:100%">
        <thead>
        <tr>
            <th style="color:#3c763d" class="resultCount"></th>
        </tr>
        <tr>
            <th>Material Number</th>
            <th>Material Type</th>
            <th>Description</th>
            <th>Material Group</th>
            <th>Packaging Material Type</th>
            <th>Created On</th>
            <th>Name of Person who Created the Object</th>
            <th>Maintenance status</th>
            <th>Industry Sector</th>
            <th>Base Unit of Measure</th>
            <th>Product hierarchy</th>
        </tr>

        <tbody>
        </tbody>
        </thead>

    </table>
    <div class="row">
        <div id="show-pagination">
        </div>
        <!--<input class="hidden btn btn-default" id="loadMore" value="Load More" type="button" onclick="loadMore()">-->
    </div>
</div>


<script type="text/html" id="template">
    <% if(data.showPrevious){%>
    <input type="button" onclick="previousSlotPagination()" class="pagination previous" value="<">
    <%}%>
    <%for(let dcount=data.start;dcount<=data.count;dcount++){%>
    <a onclick="showNextPage(this)" id="page_no_<%=dcount%>" href="javascript:void(0)"
       value=<%=dcount%>><b><%=dcount%></b></a>
    <%}%>

    <% if(data.showNext){%>
    <input id="nextSlot" type="button" onclick="nextSlotPagination()" class="pagination next" value=">">
    <%}%>
</script>
<script>
    let maximumPagination = 0

    function nextSlotPagination() {
        let text = getUrlParameter('search-text')
        let pageNo = getUrlParameter('page')
        let index = getUrlParameter('index') || 'makt'
        if (!pageNo) {
            pageNo = 0
        }
        pageNo = parseInt(pageNo) + 1
        if (text) {
            location.href = '/?search-text=' + text + '&page=' + pageNo + '&index=' + index
        }
    }

    function previousSlotPagination() {
        let text = getUrlParameter('search-text')
        let pageNo = getUrlParameter('page')
        let index = getUrlParameter('index') || 'makt'
        if (!pageNo) {
            pageNo = 0
        }
        pageNo = parseInt(pageNo) - 1
        if (pageNo < 0) {
            pageNo = 0
        }
        if (text) {
            location.href = '/?search-text=' + text + '&page=' + pageNo + '&index=' + index
        }
    }

    function showNextPage(that) {
        let text = getUrlParameter('search-text')
        let pageNo = $(that).attr('value')
        let index = getUrlParameter('index') || 'makt'
        let redirectText = '/?search-text=' + text
        if (pageNo > 0) {
            redirectText = redirectText + '&page=' + pageNo + '&index=' + index
        }
        if (!pageNo || pageNo < 0) {
            pageNo = 0
        }

        location.href = redirectText
    }

    let showNext = false
    let showPrevious = false
    var getUrlParameter = function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : sParameterName[1];
            }
        }
    };

    (function () {
        let text = getUrlParameter('search-text')
        let index = getUrlParameter('index') || 'market'

        $("#search-text").val(text)
        $("#selected_index").val(index)

        if (text) {
            let pageNo = getUrlParameter('page')
            if (!pageNo || !pageNo / 1) {
                pageNo = 0
            }
            if (pageNo > 0) {
                pageNo = pageNo - 1
            }

            loadMore(index, text.trim(), pageNo)
        }

    })()

    function loadMore(index, searchText, pagination) {
        //  let searchText = $("#search-text").val().trim()
        if (!index || index == "") {
            return false
        }
        let source = []
        if (index == 'market') {
            source = ['mara_matnr', 'mara_mtart', 'mara_matkl', 'mara_vhart', 'mara_ersda', 'mara_ernam', 'mara_pstat', 'mara_mbrsh', 'mara_meins', 'mara_prdha', 'makt_props']
        }
        if (searchText && (searchText == "" || !searchText || searchText.length < 3)) {
            $('#meterial_table').addClass('hidden')
            $('#loadMore').addClass('hidden')
            return false
        }
        $.ajax({
            url: '../api/search',
            data: JSON.stringify({
                index: index,
                text: searchText,
                from: pagination * 10,
                source: source
            }),
            method: 'POST',
            dataType: 'json',
            contentType: "application/json",
            success: function (data) {
                if (index == 'market') {
                    $('.results').removeClass('hidden')
                } else {
                    $('.customer_results').removeClass('hidden')
                }
                var template = $('#template').html()
                let pageCount = Math.floor(data.count / 10)
                let extraPage = Math.floor(data.count % 10)
                if (pageCount > 0 && extraPage > 0) {
                    pageCount = pageCount + 1
                }
                let pageStart = 1
                if (pagination > 0) {
                    showPrevious = true
                }
                if (pageCount > 5) {
                    if (pagination <= 0) {
                        pageStart = pagination + 1
                    } else {
                        pageStart = pagination
                    }
                    pageCount = pagination + 5
                    $(".next").removeClass('hidden')
                    showNext = true
                }

                var compiled_html = _.template(template)({
                    data: {start: pageStart, count: pageCount, showNext: showNext, showPrevious: showPrevious}
                })
                if (data.result.length > 1) {
                    console.log(data.time)
                    // $(".resultCount").html("<span>" + data.time + "</span>" + "<h3><i class=\"fa fa-save\"></i></h3>")
                }

                if (data.count > 10) {
                    $("#show-pagination").append(compiled_html)
                }
                if (data.result.length < 10) {
                    $("#nextSlot").attr('disabled', true)
                }
                let pageNo = pagination + 1
                $('#page_no_' + pageNo).addClass('clicked')
                let final_data = data.result
                var counter = 1;
                if (index == "market") {
                    for (let j = 0; j < final_data.length; j++) {
                        let maktMaktx = final_data[j]['makt_props'].map(function (data) {
                            return data.makt_maktx
                        })
                        maktMaktx = maktMaktx.join("<br /><br />");
                        console.log(final_data[j]['makt_props'][0].makt_maktx)
                        $('#meterial_table').dataTable().fnAddData([
                            final_data[j].mara_matnr,
                            final_data[j].mara_mtart,
                            maktMaktx,
                            final_data[j].mara_matkl,
                            final_data[j].mara_vhart,
                            final_data[j].mara_ersda,
                            final_data[j].mara_ernam,
                            final_data[j].mara_pstat,
                            final_data[j].mara_mbrsh,
                            final_data[j].mara_meins,
                            final_data[j].mara_prdha,

                        ]);
                    }
                } else {
                    for (let j = 0; j < final_data.length; j++) {
                        let knb1_props = []

                        final_data[j]["knb1_props"].forEach(function (data) {
                            let html_data = []
                            html_data.push("knb1_akont: " + data["knb1_akont"] + ',' + " knb1_bukrs : " + data['knb1_bukrs'] + ',' + " knb1_kunnr: " + data['knb1_kunnr'] + ',' + " knb1_zterm :" + data['knb1_zterm'])
                            knb1_props.push(html_data)
                        })
                        knb1_props = knb1_props.join("<br /><br />");

                        let knvk_props = []
                        final_data[j]["knvk_props"].forEach(function (data) {
                            let html_data = []
                            html_data.push("knvk_kunnr: " + data['knvk_kunnr'] + ',' + " knvk_namev: " + data['knvk_namev'] + ',' + " knvk_name1: " + data['knvk_name1'])
                            knvk_props.push(html_data)
                        })
                        knvk_props = knvk_props.join("<br /><br />");
                        $('#customer_table').dataTable().fnAddData([
                            final_data[j].kna1_kunnr,
                            final_data[j].kna1_land1,
                            final_data[j].kna1_name1,
                            final_data[j].kna1_name2,
                            final_data[j].kna1_ort01,
                            final_data[j].kna1_pstlz,
                            final_data[j].kna1_stras,
                            knb1_props,
                            knvk_props


                        ]);
                    }
                }

                pagination++;

            }, error: function (error) {

                let msg = JSON.parse(error.responseText)
                alert(msg.message)
            }
        })
    }

    $("#search").on('click', function () {
        let searchText = $("#search-text").val().trim()
        let index = $("#selected_index").val()
        location.href = '/?search-text=' + searchText + '&index=' + index
    })
    $("#search-text").bind("keypress", {}, keypressInBox);

    function keypressInBox(e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if (code == 13) { //Enter keycode
            e.preventDefault();
            let searchText = $("#search-text").val().trim()
            let index = $("#selected_index").val()
            location.href = '/?search-text=' + searchText + '&index=' + index
        }
    };
    $(document).ready(function () {
        $('#meterial_table').DataTable({
            "dom": 'Zlfrtip',
            "colResize": {
                "tableWidthFixed": false
            },
            "paging": false

        });
        $('#customer_table').DataTable({
            "dom": 'Zlfrtip',
            "colResize": {
                "tableWidthFixed": false
            },
            "paging": false

        })
        /* $('#search-text').on('keyup', function (word) {
             let txt = $('#search-text').val().trim()
             if (txt.length > 2) {
                 $.ajax({
                     url: '/api/suggest-search',
                     method: 'POST',
                     dataType: 'json',
                     data:JSON.stringify({
                         text:txt,
                         source:['mara_matnr','mara_mtart','mara_ernam','makt_props.makt_maktx']
                     }),
                     contentType: "application/json",
                     success: function (data) {
                             let showText=[]
                             let mara_ernam=data.mara_ernam.split(' ')


                     }
                 })
                 //
             }
         })
         */
    });


    $("#photos-input").on('change', function () {
        $("#upload-photos").submit();

    })
    // file upload


    $('#upload-photos').on('submit', function (event) {
        event.preventDefault();

        // Get the files from input, create new FormData.
        var files = $('#photos-input').get(0).files,
                formData = new FormData();

        if (files.length === 0) {
            alert('Select atleast 1 file to upload.');
            return false;
        }

        if (files.length > 1) {
            alert('You can only upload up to 3 files.');
            return false;
        }

        // Append the files to the formData.
        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            formData.append('photos[]', file, file.name);
        }

        formData.append('index', $('#selected_index').val())
        // Note: We are only appending the file inputs to the FormData.
        uploadFiles(formData);
    });

    function uploadFiles(formData) {
        $.ajax({
            url: '/api/uploadFile',
            method: 'post',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function () {
                var xhr = new XMLHttpRequest();

                // Add progress event listener to the upload.
                xhr.upload.addEventListener('progress', function (event) {
                    var progressBar = $('.progress-bar');

                    if (event.lengthComputable) {
                        var percent = (event.loaded / event.total) * 100;
                        progressBar.width(percent + '%');

                        if (percent === 100) {
                            progressBar.removeClass('active');
                        }
                    }
                });

                return xhr;
            }
        }).done(handleSuccess).fail(function (xhr, status) {

            alert(status);
        });
    }

    function handleSuccess(data) {
        if (data.length > 0) {
            $('.fa-upload').addClass('hidden')
            $('.fa-file-excel-o').removeClass('hidden')
            $('.fa-close').removeClass('hidden')
            $('.fa-file-excel-o').attr('fileName', data[0].publicPath)
            // var html = '';
            // for (var i=0; i < data.length; i++) {
            //     var img = data[i];
            //
            // }
            //
            // $('#album').html(html);
        } else {
            alert('No images were uploaded.')
        }
    }

    $('.fa-close').on('click', function () {
        $('.fa-file-excel-o').addClass('hidden')
        $('.fa-upload').removeClass('hidden')
        $(this).addClass('hidden')
    })
    $('.fa-upload').on('click', function () {
        $('#photos-input').trigger('click')
    })

    $('.fa-file-excel-o').on('click', function () {
        $.ajax({
                    url: '../api/download',
                    data: JSON.stringify({
                        fileName: $(this).attr('filename')
                    }),
                    method: 'POST',
                    contentType: "application/json",
                    responseType: '',
                    success: function (data) {
                        var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="";var n,r,i,s,o,u,a;var f=0;e=Base64._utf8_encode(e);while(f<e.length){n=e.charCodeAt(f++);r=e.charCodeAt(f++);i=e.charCodeAt(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)}return t},decode:function(e){var t="";var n,r,i;var s,o,u,a;var f=0;e=e.replace(/[^A-Za-z0-9+/=]/g,"");while(f<e.length){s=this._keyStr.indexOf(e.charAt(f++));o=this._keyStr.indexOf(e.charAt(f++));u=this._keyStr.indexOf(e.charAt(f++));a=this._keyStr.indexOf(e.charAt(f++));n=s<<2|o>>4;r=(o&15)<<4|u>>2;i=(u&3)<<6|a;t=t+String.fromCharCode(n);if(u!=64){t=t+String.fromCharCode(r)}if(a!=64){t=t+String.fromCharCode(i)}}t=Base64._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/rn/g,"n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t="";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}}
                    data=Base64.encode(data)
                        console.log(data)
                        var pre="data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,";
                        var downloadLink = window.document.createElement('a');
                        downloadLink.href =pre+data
                        document.body.appendChild(downloadLink);
                       downloadLink.click();
                        document.body.removeChild(downloadLink);
                    }, error: function (error) {


                    }
                }
        )
    })
</script>